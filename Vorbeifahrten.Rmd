---
title: "Darstellungen der Spektren und Levels"
output:
  html_document:
    includes:
      before_body: header.html
    self_contained: yes
    theme: united
    highlight: textmate
    fig_caption: yes
    toc: yes
---
```{r  include = FALSE}
#knitr options
library(knitr)
opts_chunk$set(
  message = FALSE, 
  warning = FALSE,
  echo = F
)

# import library and functions
library(jsonlite)
library(dplyr)
library(tidyr)
library(ggplot2)
source('ggplot_templates.R')
load("auswertungData.Rdata")
```


```{r, eval = F }
#unused plots 
ggplot(data =vDf%>%filter(Zugstyp == 'Regio'& passby==14) ) +
  geom_hline(aes(yintercept = v, group = interaction(passby,A)), color = 'blue', alpha = 0.7, size = 2)+
  geom_point(mapping = aes(x = bogie, y = vi, color =bogie.type, text =bogie.type), size = 3)+
  facet_grid(.~A)+
  ylab('v km/h')+xlab('Drehgestell')+
  scale_y_continuous(breaks = seq(80,150,5))+
  scale_x_continuous(breaks = 1:14 )+
  theme(legend.position="bottom")


ggplot(vDf%>%filter(Zugstyp =='IC'& passby == '8') ) +
  geom_hline(aes(yintercept = v, group = interaction(passby,A)), color = 'blue', alpha = 0.7, size = 2)+
  geom_point(mapping = aes(x = bogie, y = vi, color = bogie.type), size = 3)+
  facet_grid(passby*Zugstyp~A)+
  scale_color_discrete()+
  ylab('v km/h')+xlab('Drehgestell')+
  scale_y_continuous(breaks = seq(80,150,5) )+ theme_bw()+theme(legend.position="bottom")
# Darstellung Kategorisierung
ggplot(X) +
  geom_hline(aes(yintercept = v, group = interaction(passby,A)), color = 'blue', alpha = 0.7, lw = 2)+
  geom_point(mapping = aes(x = bogie, y = vi, color = bogie.type,shape = interval.kat), size = 4)+
  facet_grid(passby*Zugstyp~A)+
  scale_color_discrete()+
  scale_y_continuous(breaks = seq(80,150,5) )+ theme_bw()

```


Dieser Abschnitt dient um einen Gefühl mit die gemessene/ausgewertete daten zu bekommen.

Als erstens werden die 

Dazu wird die Streuung der berechnete Spektren bzw. Levelsuntersucht.

- innerhalb die gleichen pass-by, indem unterschiedliche Auswertung Intervalle verglichen werden
- innerhalb verschiedene pass-by der gleiche Zugs bzw. Geschwindigkeit Kategorie

**Spektern und Gesamtpegeln sind in dBA angegeben**

```{r }
# Vorbereiten der daten in long format
spectDf = spectWideDf %>% gather('var','level', leq.tot:leq.8000) %>% separate(var , c('var','band'))

#remove unused Frequencies
FREQ = c(#100, 125,
         160, 200, 250, 315, 400, 500, 630, 800, 1000,
         1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300, 8000)
spectDf = spectDf %>%filter(band != "100" & band !="125")

```

## Abschnitten B5 und B2

Für diese Abschnitte sind Spektren Wagenbezogen berechnet worden. Es ist somit möglich Spektren innerhalb die gleichen pass-by zu vergleichen. Passby  10,13 und 8 sind nicht dargestellt da langsämer gefahren sind. Alle andere passby hatten eine geschwindigkeit von ungefähr 140 km/h 


### Levels von IC Züge für Intervalle der kategorie `Wagen`

```{r  fig.width = 14, fig.height=7, out.width='800px'}
ggplot(droplevels(spectDf%>%
                    filter(band =='tot'& interval.kat=='Wagen' & (A =='B5'| A=='B2') & Zugstyp == 'IC' ))%>%
         filter(passby != "10"& passby != "13" & passby != "8"),
       aes(x = passby, y = level)
) +
  geom_boxplot(alpha = 0.7)+
  geom_point(aes(color = v),size =4,alpha = 0.6,position = "jitter")+
  ylab('Level dBA')+
  facet_grid( .~ A)+
  scale_y_continuous(breaks = seq(80,150,1) )
```

**Diskussion**:

- eine viel grössere Streuung als erwartet ist zu sehen. Zwischen unterschiedliche Intervalle der gleichen pass-by sind variationen bis 5 dB zu sehen

- Die Variabilität innerhalb ein einziges Zug ist Grösser als die Variabilität Zwischen verschiedene pass-by

- zwischen unterschiedliche pass-by (gleuche Zugstyp mit ähnlichen Geschwindigkeiten) sind bis zu 2-3dB Unterschieden zu sehen

- die Streuung ist nicht konstant für ein gegebens passby auf beide Abschnitte.Damit ist es nichtmöglich die streuung zu Erklären aufgrund unterschidelich Radrauheiten. 

### Spektren von IC Züge für Intervalle der kategorie `Wagen`

```{r fig.width = 14, fig.height=6, out.width='1000px'}
SpectPlot(FREQ) + 
  geom_line(data= spectDf%>%
              filter(band!='tot'& interval.kat=='Wagen' &  (A =='B5'| A=='B2') & Zugstyp == 'IC' )%>%
              filter(passby != 10& passby != 13 & passby != 8),
            mapping = aes(x = as.numeric(band), y = level, group = interaction(passby, A, interval, var), color = passby ),
            size = 1.5, alpha=0.5) +
  scale_y_continuous(breaks = seq(20,150,5) )+
  ylab('Level dBA')+
  facet_grid(interval.kat ~ A)

```
Bemerkungen:

- Die Spektren weisen ein sehr hohen tonales Anteil bei $2000 Hz$ auf. Eine mögliche Erklärung ist der  höhe Rauheitswert bei $2\,cm$ Wellenänghe welche umgewandelt in Frequenz (für $140 km/h$) betragt $`r v= 140/3.6; round(v/0.02,-1) ` \, Hz$.



### Spektren und Levels von Regio Züge

```{r eval=F, fig.width = 14, fig.height=10, out.width='800px'}
# unused plot
ggplot(droplevels(spectDf%>% filter(band =='tot'& interval.kat!='full'& interval.kat!='vorbei' & (A =='B5'| A=='B2') & Zugstyp == 'Regio' )),aes(x = passby, y = level)) +
  #geom_boxplot(alpha = 0.7)+
  geom_point(aes(color = v), size =4,alpha = 0.6)+
 facet_grid( interval.kat~ A)+
  ylab('Level dBA')+
  scale_y_continuous(breaks = seq(80,150,1) )
```
Levels von Regio Züge für Intervalle der Kategorie `Wagen` und `Trieb/Wagen` sind nicht angezeigt da diese Züge nur aus 6 Wagen bestehen, davon 2 mit Triebfahrzeuge und deshalb hat man innerhalb ein einziges Zug nur wenige Intervalle zu Vergleichen. 

Eine sehr grosse Variabilität der Schalldruckpegel wurde wie für IC Züghe auch festgestellt.

die spektern Spektren  für Intervalle der kategorie `Trieb/Wagen` sind im folgende Bild dragestellt

```{r  fig.width = 14, fig.height=6, out.width='1000px'}
SpectPlot(FREQ) + 
  geom_line(data= spectDf%>%
              filter(band!='tot'& interval.kat=='Wagen' &  (A =='B5'| A=='B2') & Zugstyp == 'Regio' ),
            mapping = aes(x = as.numeric(band), y = level, group = interaction(passby, A, interval, var), color = passby ),
            size = 1.5, alpha=0.5) +
  ylab('Spektrum dBA')+
  scale_y_continuous(breaks = seq(20,150,5) )+
  facet_grid(interval.kat ~ A)

```

Diskussion:

- die höhe tonalität bei 2000 Hz ist ausgeprägt wie beim IC Wagen.
- Diese Züghe sind lauter als IC Züghe
- dazu ist eine grose Streuung beit tiefe Frequenzen

## Alle Abschnitte

Die Spektren berechnet aus Intervalle `full`  werden hier gezeigt. Da für die Abschnitte B3 und B4 keine LS eingesetzt wurde ist es nicht möglich drehgestellweise auszuwerten. Den Anzahl von Levels ist deswege gering, jedoch gelten die bereits gemachten Bemerkungen über variabilität zwischen unterschiedliche Züghe der gleiche Klasse  auch für die Abschnitten B3 und B4.

```{r fig.width = 14, fig.height=10, out.width='1000px'}
SpectPlot(FREQ) + 
  geom_line(data= spectDf%>%
              filter(band!='tot'& interval.kat=='full' &  (A =='B3'| A=='B4')),
            mapping = aes(x = as.numeric(band), y = level, group = interaction(passby, A, interval, var), color = passby ),
            size = 1.5, alpha=0.5) +
  scale_y_continuous(breaks = seq(20,150,5) )+
  ylab('Level dBA')+
  facet_wrap(Zugstyp ~ A,scales='free_x')

```
<!--
## Leq vs. Geschwindigkeit für  IC Züghe

Für IC Züghe sind genügende Levels berechnetworden um sinnvoll eine  regression der Level Gegnüber die geschwindigkeit darzustellen. Die Frage die man beantworten will ist :

`Ist die Variabilität erklart aus die Geschwindigkeitunterschiede?`

Die Antwort ist`nein` und war  schon in Früheren Abbildungen zu raten. Die nächste Graphik, wo Leq Werte gegen die Geschwindigkeit dargestellt werden, versucht die Frage genauer zu bentworten.

Man erwartet zunehmender Leq mit zunehmender Geschwindigkeit ($leq \propto log_{10}v$).
-->

```{r eval = FALSE, fig.width = 14, fig.height=10, out.width='800px'}
# unused plot
ggplot(droplevels(spectDf%>%filter(!is.na(v)& band=='tot'& Zugstyp == 'IC')),
        aes(x = v, y = level)) + 
  #geom_boxplot(mapping = aes(x = A, y = level, color = interval)) +
  geom_point(aes(x = v, y = level, color =passby),size =3,alpha = 0.6)+
  stat_smooth(method = "lm", formula = y ~ 1+log(x), se = FALSE,size = 1,alpha = 0.5)+
  facet_grid(A~interval.kat)+
  ylab('Level dBA')+xlab('v, km/h')+
  scale_y_continuous(breaks = seq(80,150,5) )+ theme_bw()+ theme(legend.position="bottom")
  
```

----

## Anhang
Quellencode diesem Teil ist im file [Quellencode](https://github.com/e-sr/ValFX/blob/master/AkustischeMessungNiederwangen/StatAuswe.Rmd) zu sehen.

----

---
title: "Schallpegel und Spektren; erste Darstellungen"
output:
  html_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 10
    highlight: textmate
    includes:
      before_body: includes/header.html
    self_contained: yes
    theme: united
    toc: yes
  word_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 9
---
```{r  include = FALSE}
#knitr options
library(knitr)
opts_chunk$set(
  message = FALSE, 
  warning = FALSE,
  echo = F
)

# import library and functions
library(jsonlite)
library(dplyr)
library(tidyr)
library(ggplot2)
source('ggplot_templates.R')
load("auswertungData.Rdata")
```


```{r, eval = F }
#unused plots 
ggplot(data =vDf%>%filter(Zugstyp == 'Regio'& passby==14) ) +
  geom_hline(aes(yintercept = v, group = interaction(passby,A)), color = 'blue', alpha = 0.7, size = 2)+
  geom_point(mapping = aes(x = bogie, y = vi, color =bogie.type, text =bogie.type), size = 3)+
  facet_grid(.~A)+
  ylab('v km/h')+xlab('Drehgestell')+
  scale_y_continuous(breaks = seq(80,150,5))+
  scale_x_continuous(breaks = 1:14 )+
  theme(legend.position="bottom")


ggplot(vDf%>%filter(Zugstyp =='IC'& passby == '8') ) +
  geom_hline(aes(yintercept = v, group = interaction(passby,A)), color = 'blue', alpha = 0.7, size = 2)+
  geom_point(mapping = aes(x = bogie, y = vi, color = bogie.type), size = 3)+
  facet_grid(passby*Zugstyp~A)+
  scale_color_discrete()+
  ylab('v km/h')+xlab('Drehgestell')+
  scale_y_continuous(breaks = seq(80,150,5) )+ theme_bw()+theme(legend.position="bottom")
# Darstellung Kategorisierung
ggplot(X) +
  geom_hline(aes(yintercept = v, group = interaction(passby,A)), color = 'blue', alpha = 0.7, lw = 2)+
  geom_point(mapping = aes(x = bogie, y = vi, color = bogie.type,shape = interval.kat), size = 4)+
  facet_grid(passby*Zugstyp~A)+
  scale_color_discrete()+
  scale_y_continuous(breaks = seq(80,150,5) )+ theme_bw()

```

----

In diesem Auswertung-teil werden Schallpegel und Spektren der Vorbeifahrten  für die folgende Punkte:

- Tonale Charakteristik von Vorbeifahrten

- Die Streuung von Schallpegeln bzw. Spektren für folgende Gruppen:

    - innerhalb die gleichen Vorbeifahrt, indem unterschiedliche Wagen gleichen Wagentyp verglichen werden
    - innerhalb verschiedene Vorbeifahrt der gleiche Zugs bzw. Geschwindigkeit Kategorie

Es muss beachtet werden dass die Mikrophone auf eine total reflektierende Fläche montiert wurden. Der Abstand dieser Fläche aus Gleismitte war nur 2.5m. Als folge sind viel höhere Schallpegeln erwartet im vergleich zur gewöhnlichen Vorbeifahrtmessungen (Details im EMPA Bericht).


```{r }
# Vorbereiten der daten in long format
spectDf = spectWideDf %>% gather('var','level', leq.tot:leq.8000) %>% separate(var , c('var','band'))

#remove unused Frequencies
FREQ = c(#100, 125,
         160, 200, 250, 315, 400, 500, 630, 800, 1000,
         1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300, 8000)
spectDf = spectDf %>%filter(band != "100" & band !="125")

```

----

### Schallpegeln und Spektren alle Abschnitte im Vergleich

Die Spektren berechnet aus Intervalle `full`  werden hier gezeigt. Da für die Abschnitte B3 und B4 keine LS eingesetzt wurde ist es nicht möglich Wagen bezogene Spektren zu Vergleichen.  IC Vorbeifahrt  10, 13 und 8 und Regio Vorbeifahrt 6 sind nicht dargestellt wegen die zu kleine Geschwindigkeit. Alle andere Vorbeifahrten hatten eine Geschwindigkeit von ungefähr 140 km/h 

```{r  fig.height=9}
SpectPlot(FREQ) + 
  geom_line(data= spectDf%>%
              filter(band!='tot'& interval.kat=='full' )%>%
              filter(passby != "10"& passby != "13" & passby != "8"& passby != "6"),
            mapping = aes(x = as.numeric(band), y = level, group = interaction(passby, A, interval, var), color = Zugstyp ),
            size = 1.5, alpha=0.5) +
  scale_y_continuous(breaks = seq(20,150,5) )+
  ylab('dBA')+
  facet_wrap (~A,ncol = 2 )

```
<!--
## Leq vs. Geschwindigkeit für  IC Züghe

Für IC Züghe sind genügende Schallpegel berechnetworden um sinnvoll eine  regression der Level Gegnüber die geschwindigkeit darzustellen. Die Frage die man beantworten will ist :

`Ist die Variabilität erklart aus die Geschwindigkeitunterschiede?`

Die Antwort ist`nein` und war  schon in Früheren Abbildungen zu raten. Die nächste Graphik, wo Leq Werte gegen die Geschwindigkeit dargestellt werden, versucht die Frage genauer zu bentworten.

Man erwartet zunehmender Leq mit zunehmender Geschwindigkeit ($leq \propto log_{10}v$).
-->

```{r eval = FALSE,fig.height=9}
# unused plot
ggplot(droplevels(spectDf%>%filter(!is.na(v)& band=='tot'& Zugstyp == 'IC')),
        aes(x = v, y = level)) + 
  #geom_boxplot(mapping = aes(x = A, y = level, color = interval)) +
  geom_point(aes(x = v, y = level, color =passby),size =3,alpha = 0.6)+
  stat_smooth(method = "lm", formula = y ~ 1+log(x), se = FALSE,size = 1,alpha = 0.5)+
  facet_grid(A~interval.kat)+
  ylab('Level dBA')+xlab('v, km/h')+
  scale_y_continuous(breaks = seq(80,150,5) )+ theme_bw()+ theme(legend.position="bottom")
  
```
  **Diskussion**:
  
  - Die  IC Spektren weisen ein sehr hohen tonales Anteil bei 2000 Hz auf. Eine mögliche Erklärung ist der höhe Rauheitwert bei 2cm Wellenlänge welche umgewandelt in Frequenz (für 140 km/h) entspricht `r v= 140/3.6; round(v/0.02,-1) ` \, Hz.
  
   - Die  Regio Spektren weisen diesem tonales Anteil nicht. Wir Untersuchen diese in einem weiteren Abschnitt
  
  -  Die Variabilität zwischen unterschiedliche IC Züge ist gross. Diese Beobachtung wird in übernächsten Abschnitt weiter untersucht. Den geringe Anzahl Regio Züge ermöglicht keine Aussagen über Variabilität. 

----

###  Wagenbezogenen Schallpegeln von IC wagen in Vergleich

Für diese Abschnitte sind Schallpegeln und Spektren Wagen bezogen berechnet worden. Es ist somit möglich Schallpegeln und Spektren einzelne Wagen auf unterschiedliche Abschnitte Zu Vergleichen. Vorbeifahrt  10, 13 und 8 sind nicht dargestellt wegen die zu kleine Geschwindigkeit. Alle andere Vorbeifahrt hatten eine Geschwindigkeit von ungefähr 140 km/h 

Es werden nur Schallpegeln und Spektren von  *IC Züge*,  Wagentyp `Wagen`, für die Diskussion Verwendet. Schallpegel von Regio Züge für Intervalle der Kategorie `Wagen` und `Trieb/Wagen` sind nicht angezeigt da diese Züge nur aus 6 Wagen bestehen, davon 2 mit Triebfahrzeuge und deshalb hat man innerhalb ein einziges Zug nur wenige Wagen bezogene Spektren der gleichen Wagentyp zu Vergleichen. 


```{r }
ggplot(droplevels(spectDf%>%
                    filter(band =='tot'& interval.kat=='Wagen' & (A =='B5'| A=='B2') & Zugstyp == 'IC' ))%>%
         filter(passby != "10"& passby != "13" & passby != "8"),
       aes(x = A, y = level)
) +
  geom_boxplot(alpha = 0.7)+
  geom_point(aes(color = interval),size =4,alpha = 0.6,position = "jitter")+
  ylab('dBA')+
  xlab('Abschnitt')+
  facet_wrap( ~ passby,nrow=1)+
  scale_color_discrete(name='Wagen n')+
  scale_y_continuous(breaks = seq(80,150,1) )
```

  **Diskussion**:
  
  - Die Streuung ist viel grösser als erwartet. Zwischen  Wagen der gleiche Vorbeifahrt sind Variationen bis 5 dBA zu sehen
  - Die Streuung zwischen Vorbeifahrt  sind bis zu 2-3dBA Unterschieden zu sehen.
  - Die Variabilität der Wagen innerhalb ein einziges Zug ist Grösser als die Variabilität Zwischen  Vorbeifahrt. (Median Betrachtung)
  - Die Variabilität innerhalb einer Vorbeifahrt ist nicht Konstant (und Konsistent) auf unterschiedliche Abschnitte. Damit ist es nicht möglich die Streuung aufgrund unterschiedlich Radrauheiten zu erklären.

----

### Tonale Charkteristik von Vorbeifhahrten für Wagenbezogene Spktren

Wir wollen die Tonalität Charakteristik der Vorbeifahrten weiter untersuchen. Verantwortlich diese Tonalität Erscheinung ist meistens den Effekt der Überlagerung von SR und Radrauheit. Hier wird es behauptet dass alleine die SR verantwortlich ist. Wir betrachten hier deswegen nur Wagen bezogene Spektren (Abschnitt B5 und B2) von  Wagentyp `wagen` (ohne Triebdrehgestelle). Grund dafür ist die höhe Radrauheit von Triebdrehgestelle.


```{r fig.height=9  }
SpectPlot(FREQ) + 
  geom_line(data= spectDf%>%
              filter(band!='tot'& interval.kat=='Wagen' &  (A =='B5'| A=='B2')  )%>%
              filter(passby != 10& passby != 13 & passby != 8 & passby != 6),
            mapping = aes(x = as.numeric(band), y = level, group = interaction(passby, A, interval, var), color = passby ),
            size = 1.5, alpha=0.5) +
  scale_y_continuous(breaks = seq(20,150,5) )+
  ylab('dBA')+
  facet_grid(Zugstyp~ A)+
   scale_color_discrete(name='Vorbeifahrt')+ theme(legend.direction = "horizontal")

```

  **Diskussion**:
  
  - Alle Spektren weisen ein sehr hohen tonales Anteil bei 2000 Hz auf.
  - Wagen bezogenen Spektren der Abschnitt B5  weisen ein höheres tonales Anteil bei 2000 Hz  gegenüber Spektren Von gesamten Zugdurchfahrten (Vergleiche Bild im Ersten Abschnitt)
  - Die höhe Tonalität von Regio Wagen bei 2000 Hz ist ausgeprägt wie beim IC Wagen.
  - Regio Züge sind lauter als IC Züge und haben eine grössere Streuung bei tiefe Frequenzen.
  -  Die obere Punkten verstärken die Erklärung der Tonalität durch die höhe SR. Mann Kann behaupten dass diese SR (bei 2cm Wellenlänge) in ähnlichen mass auf beide Abschnitten Vorhanden ist 
  
Die Vorbeifahrt nummer 6 besteht aus einem Regio Zug welcher 100 km/h gefahren ist. Dieser Zug muss aufgrund der tiefe  Geschwindigkeit separat betrachtet werden. Im nächsten Bild sind die Spektren dieser Zug angezeigt.

```{r }
SpectPlot(FREQ) + 
  geom_line(data= spectDf%>%
              filter(band!='tot'& passby =="6"& interval.kat!='full'  ),
            mapping = aes(x = as.numeric(band), y = level, group = interaction(passby, A, interval, var), color = A ),
            size = 1.5, alpha=0.5) +
  scale_y_continuous(breaks = seq(20,150,5) )+
  ylab('dBA')+
  facet_grid(.~ interval.kat)+
   scale_color_discrete(name='Vorbeifahrt')+ theme(legend.direction = "horizontal")

``` 

  **Diskussion**:
  
  - Die Wagen Spektren weisen ein sehr hohen tonale Anteil beim 1600Hz Band auf. Das entspricht mit der Anregung der 2cm Wellenlänge, welche umgewandelt in Frequenz (für 100 km/h) `r v= 100/3.6; round(v/0.02,-1) ` \, Hz  entspricht.
  - Die Antrieb/Wagen Wagentyp haben kein tonales Anteil bei 1600Hz. Diese Wagentyp ist gleichzeitig viel lauter was auf einer dominante Radrauheit deutet.
  - Weiterhin  kann behauptet werden dass die SR (bei 2cm Wellenlänge) in ähnlichen mass auf beide Abschnitten Vorhanden ist.

----

### Wichtige Erkentnisse
  
> - Alle Spektren weisen ein sehr hohen tonales Anteil bei 2000 Hz auf. Grund dafürkönnte die hohe SR bei 2 cm Wellenlänghe sein. Man Kann behaupten dass die SR bei 2 cm Wellenlänghein ähnlichen mass auf alle Abschnitten Vorhanden ist. Vergleiche dazi die SR Messungen.
  - Regio Züge sind lauter als IC Züge und haben eine grössere Streuung bei tiefe Frequenzen.
  - Die Streuung von Schallpegel und Spekteren ist viel grösser als erwartet. Für IC Züge gilt: 
    - Zwischen Wagen der gleiche Vorbeifahrt sind Variationen bis 5 dBA zu sehen.
    - Die Variabilität innerhalb einer Vorbeifahrt ist nicht Konstant (und Konsistent) auf unterschiedliche Abschnitte.Damit ist es nicht möglich die Streuung aufgrund unterschiedlich Radrauheiten zu erklären
  
----


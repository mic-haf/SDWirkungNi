---
title: "Gemessene Schienenrauheit in Niederwangen"
output:
  word_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 9
  html_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 10
    highlight: textmate
    includes:
      before_body: includes/header.html
    self_contained: yes
    theme: united
    toc: yes
    toc_depth: 4
---
```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(
  message = FALSE, 
  warning = FALSE,
  echo = F
)

#import library and functions
library(jsonlite)
library(dplyr)
library(tidyr)
library(captioner)
# table_nums <- captioner(prefix = "Tabelle")
# fig_nums <- captioner(prefix = "Bild")
source('ggplot_templates.R')
load("auswertungData.Rdata")

Sys.setlocale("LC_TIME", "German")
```

```{r}
schleifVorgang = ISOdate(2013, 11, 1)
Messungen = SRni%>%group_by(Author,kampagne,messdatum)%>%summarize(Messdatum = strftime(messdatum[1], '%B-%Y') )
colnames(Messungen)[c(1,2)] = c('Messbüro', 'Messkampagne')
```
----

In Niederwangen wurden im `r  strftime(schleifVorgang, '%B-%Y')` die Schienen geschliffen. Danach wurde der Zustand der SR mehrmals von MBBM und ACCON gemessen. Folgende Messkampagnen wurden durchgeführt:

- MBBM hat 4 mal alle Abschnitte gemessen
- ACCON hat Abschnitt B5 und B2 einmal gemessen

Zur MBBM Messkampagne sind detaillierte Berichte verfügbar.

```{r}
kable(Messungen[,c(1,2,4)])
```

----

### Darstellung der gemessenen SR Spektren

```{r fig.height=9}
SRni = SRni %>%  mutate(months = as.numeric(difftime( messdatum,schleifVorgang, units = "days"))/30)

RauheitsPlot()+
  geom_line(data= SRni ,
            aes(x=wl,y=R, group = r_id,colour = months , linetype = Author),
            size = 1,alpha = 0.7)+
  facet_wrap(~sec,ncol = 2)+
  scale_color_gradient(name='Monaten nach Schleifen  ')+ theme(legend.direction = "horizontal")

```

**Diskussion:**

  - SR  und Radrauheit  bilden zusammen die Anregungsmechanismus des Rollgeräuschs. Falls die SR weit unterhalb der TSI Kurve (schwarze Kurve) liegt, darf angenommen werden, dass die Radrauheit zur Hauptsache verantwortlich für die Anregung ist. In Niederwangen ist das  für Wellenlängen im Bereich von 1.6-4 cm nicht der Fall und es ist deshalb anzunehmen dass die SR die Hauptanregung bewirkt. Die gemessenen Schallspektren, welche eine stark tonale Komponente bei 2000Hz aufweisen (alle Abschnitte), stützen diese These. Diese tonale Komponente entspricht bei 130 km/h ungefähr die 2 cm Wellenlänge. In vorliegender Auswertung ist die SR speziell bei 1.6-4cm  Wellenlängen zu betrachten.
  
  - Die SR haben eine Spitze bei 2cm und 1.6 cm Wellenlänge. Die Rauhigkeit bei 2 cm ist durch das Schleifvorgang bedingt, das ist  ein bekannter Effekt. Die genaue Wellenlänge hängt von unterschiedlichen Schleifparametern (Korngrösse der Schleifsteine, Geschwindigkeit , Maschine) ab.
  
  - Diese Spitze ist in jedem Abschnitt zu sehen und nimmt mit der Zeit ab. Die Abnahme ist unterschiedlich von Abschnitt zu Abschnitt. Diese Abnahme ist viele kleiner als erwartet. 2 Jahren später ist immer noch eine Schleifrauheit zu sehen. 
  
  - ACCON und MBBM messen die Spitze unterschiedlich. Diese Unterschiede sind vor allem in Abschnitt B2 zu sehen. ACCON misst eine grössere Schleifrauheit als MBBM.
  
  - Die Schallmessung weist für alle Abschnitte eine starke Tonalität auf. Das entspricht nicht mit der kürzlich gemessenen SR überein, wo nur die Referenz die Spitze aufweist.
  
  - Die SR ist der Resultat von der Auswertung und Mittelung mehrerer 1m Abschnitte in Längsrichtung (vgl. detaillierte MBBM Berichte für mehr Informationen). Die Variation zwischen den 1m Abschnitten ist unbekannt.
  
  - Die SR beziehen sich auf die Fahrspiegelmitte. Eine Variation in transversaler Richtung ist zu erwarten. Es ist zu bemerken, dass die Radposition jedes Drehgestell von dieser Mitte abweichen kann. Konsequenz ist, dass jedes Drehgestell eine andere SR spürt.

----

### Korrektur von Schallspektren

In Niederwangen werden Schallspektren von mehreren Abschnitten miteinander verglichen. Genauer wird die Differenz zwischen Referenz und Dämpferabschnitt gebildet, um die SD Wirkung abzuschätzen. Da diese Abschnitte unterschiedliche SR aufweisen könnten, kann die gebildete Differenz in der Theorie mithilfe von SR Differenzen korrigiert werden.

Die Ermittlung einer SR Korrektur für die Schallspektren erfolgt in 2 Schritten
 
 1. Auswahl einer repräsentativen SR für jeden Abschnitt
 2. Schallspektren-Korrektur bilden

#### Auswahl einer representativen SR für Schallspektren-Korrekturen

Da die Schallspektren 2000Hz Spitzen aufweisen, ist die SR vor allem bei 2cm Wellenlänge zu betrachten.

Als logischer Ansatz würde man die kürzlich vor der Schallmessung gemessene SR verwenden, d.h MBBM Messkampagne 4. 
Es gibt jedoch Gründe, andere Messkampagnen für die repräsentative SR einzubeziehen: 

  - Abnahme der SR ist klein, d.h. vorletzte SR Messkampagne könnte auch noch repräsentativ sein.
  - Die ACCON-Werte sollen mit verwendet werden (auch noch relativ kürzlich zur Schallmessung), um Unterschiede aufgrund des Messbüros auszuschliessen.
  - Messkampagne 4 weist nicht bei allen Abschnitte höhere SR Werte bei 2 cm auf. Dies ist inkonsistent mit den 2000Hz Spitze bei den gemessenen Schallspektren.
  - Variabilität der SR ist gross. Ein Mittelwert scheint deshalb geeigneter/robuster zu sein.
    
Als Folge dieser Überlegungen untersuchen wir die folgenden **3 Fälle, um eine repräsentative SR** zu definieren:

  a. ACCON Messkampagne 1, MBBM Messkampagne 3 und MBBM Messkampagne 4
  b. MBBM Messkampagne 3 und MBBM Messkampagne 4
  c. MBBM Messkampagne 4. Aufgrund des geringen zeitlichen Abstands zur akustischen Messung, sollte diese SR die realistischste sein

Mehrere SR Spektren können in einem einzelnen gemittelten Spektrum zusammengefasst werden. Die Mittelung erfolgt je Band energetisch.

Das nächste Bild zeigt das Beispiel für den Fall a.

```{r, fig.height=9}
SRni_filt= droplevels(SRni %>% filter( Author == 'ACCON' | kampagne == 3|kampagne==4))
av.a_SRni = SRni_filt %>%
  group_by(sec,wl)%>%
  summarize(fall='a', avR = 10*log10(sum(10^(R/10))/length(R)) )

RauheitsPlot()+
  geom_line(data=SRni_filt,
            aes(x=wl,y=R, group = r_id, colour = months,linetype = Author ),
            size = 1.5,alpha = 0.8)+
  geom_line(data = av.a_SRni,
          aes(x=wl,y=avR),
          size = 1.5,alpha = 0.8,colour = 'red')+
  facet_wrap(~sec,ncol = 2)

# fall b
SRni_filt= SRni %>% filter( kampagne == 3|kampagne==4)
av.b_SRni = SRni_filt %>%
  group_by(sec,wl)%>%
  summarize(fall='b', avR = 10*log10(sum(10^(R/10))/length(R)) )
# fall c
SRni_filt= SRni %>% filter( kampagne==4)
av.c_SRni = SRni_filt %>%
  group_by(sec,wl)%>%
  summarize(fall='c', avR = 10*log10(sum(10^(R/10))/length(R)) )
# rbind
av_SRni=rbind(av.a_SRni,av.b_SRni,av.c_SRni)
rm(av.a_SRni,av.b_SRni,av.c_SRni,SRni_filt)
```

**Representative SR im Vergleich**

Das nächste Bild zeigt einen Vergleich für die drei Fälle der repräsentative SR.

```{r fig.width=5.5}
RauheitsPlot()+
  geom_line(data = av_SRni,
          aes(x=wl,y=avR,  colour = sec,shape = fall),
          size = 1,alpha = 0.7)+
scale_colour_discrete(name = 'Abschnitt')+
geom_point(data = av_SRni,
          aes(x=wl,y=avR,  colour = sec, shape = fall),size = 3,alpha = 0.8)+
  scale_shape_discrete(name = '')
```

Es ist zu sehen, dass die gemittelten SR Werte stark streuen. Die Streuung betragt beim 2cm und 1.6 cm Wellenlänge bis zu 10dB. Diese Streuung wird grosse Konsequenzen auf die Korrektur von Schallspektren und die Berechnung der Wirkung von SD haben.
Weiter ist zu bemerken, dass der Referenz Abschnitt die grösste SR aufweist. Es ist also allein wegen der SR und nicht nur wegen dem Fehlen von SD zu erwarten, dass dieser Abschnitt lauter ist.


#### Korrektur bilden
Das vorgehen um Schallspektren-Korrekturen aufgrund von Gesamtrauheits-Differenzen zu bilden, ist das folgende:

1. Umwandeln der Gesamtrauheit von Wellenlänge zur Frequenz Hz (abhängig von der Geschwindigkeit des gemessenen Zugs):
    - $R_{tot,B}(f = \frac{v}{\lambda}) =  R_{tot,B}(\lambda)$
    - lineare Interpolation um die Werte bei der gewünschte Frequenz zu bekommen
  
2. Definiere Korrektur Filter bezüglich Referenzabschnitt: 
$$Korr_{B}(f) = -\Delta R_{tot,B}(f) = -\left( R_{tot,B}(f) -  R_{tot,B5}(f) \right)$$

3. Korrigiertes Spektrum für jeden Abschnitt berechnen: 

$$S_{B}(f) = S_{B}(f) + Korr_{B}(f)$$


Die **Gesamtrauheit** (Schiene + Rad) ist in der Regel notwendig, um diese Korrekturen durchzuführen. In unserem Messsetup ist die Schienenrauheit bei 2 cm jedoch sehr hoch und die Spektren zeigen den grössten Anteil der Energie bei der resultierenden Frequenz. Damit kann man zumindest für die 2cm Wellenlänge annehmen, dass $R_{tot,B} \approx SR_{B}$ und die Schalldruck Korrekturen mit der SR alleine durchgeführt werden dürfen.


```{r include=FALSE}

Rf <- function(R,wl,f,v){
  return(approx(100*v/(wl*3.6) , R, f ,method="linear")$y)
}

R_korr<- function(wl,R,f,v,fall){
  # ref
  df = av_SRni
  Rref = df$avR[df$sec == 'B5'& df$fall == fall]
  wlRef = df$wl[df$sec == 'B5'& df$fall == fall]
  print(any(abs(wl-wlRef)> 0.01))
  return(-Rf(R,wl,f,v)+Rf(Rref,wlRef,f,v))
}

Spect_korr = function(v,freq){
  df = av_SRni %>% filter(sec!='B5')
  df = df%>%group_by(sec,fall)%>%
  do(data.frame(sec = .$sec[1],fall = .$fall[1],v=v, freq =freq, K= R_korr(.$wl,.$avR,freq, v,.$fall[1])))
  return(df)
}
# save(list=c('Rf','Spect_korr','R_korr','av_SRni'),
#      file = 'Rauheit_korrektur.Rdata'
#     )

##Example
v = 130
korr_plot = Spect_korr(v,freqTDR)

```

**Beispiel: $130km/h$**

Für eine Geschwindigkeit von `r v` $km/h$ bekommt man für die Abschnitten B2 und B4 die folgende Schallspektren Korrekturen:

```{r }
SpectPlot(freqTDR)+
  geom_hline(yintercept = 0, size = 1)+
  geom_line(data=korr_plot%>%filter(sec !='B3'),
            aes(x =freq ,y=K,colour=sec,group= interaction(fall,sec)), size=1, alpha = 0.7)+
  geom_point(data=korr_plot%>%filter(sec !='B3'),
          aes(x=freq,y=K,  colour = sec, shape = fall),size = 4,alpha = 0.8)+
  scale_shape_discrete(name = '')+
  facet_grid(.~sec)+ guides(colour=FALSE)
  
```

**Diskussion:**

- Die Korrektur beim 2000 Hz streut sehr stark und ist in der Grössenordnung von 0.5-7dB für den Abschnitt B2 und 0.5-4.5dB für den Abschnitt B4. Diese Korrekturen sind viel grösser als erwartet und scheinen wenig plausibel zu sein.

- Die Korrekturen sind positiv, das heisst die Abschnitte sollten lauter sein, wenn die SR wie beim Referenz Abschnitt B5 wäre. Diese Korrekturen haben zur Folge, dass die SD Wirkung kleiner wird oder sogar negativ.

- Die unterschiedlichen Fälle scheinen ein zufälliges Verhalten zu haben.

- Aufgrund dieser Diskussion wird verzichtet die Korrekturen anzuwenden.

----

### Wichtige Erkentnisse

>  - SR in Niederwangen haben eine Spitze beim 2cm Wellenlänge.
   - Die Ausprägung der Spitze ist unterschiedlich von Abschnitt zu Abschnitt. Die zwei Messbüro messen unterschiedliche Werte.
   - Die SR haben eine grosse Variabilität. Gross im Bezug auf den Effekt der SR auf Schallemissionen.
   - Auswahl einer repräsentative SR für jeden Abschnitt ist nicht möglich.
   - Die berechneten Korrekturen zeigen grosse Variationen aufgrund der Auswahl der repräsentativen SR und damit grosse Effekte auf die Schallemissionen. Deswegen wird verzichtet die SR Korrekturen auf Schallspektren anzuwenden.
   - Die gemessene Wirkung der SD ist dennoch im Kontext der unterschiedlichen SR der Abschnitte zu relativieren.

----
